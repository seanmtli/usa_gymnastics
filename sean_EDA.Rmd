---
title: "sean_EDA"
author: "Sean Li"
date: "2023-11-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
simulate_gymnastics_event <- function(event_name, gender, nsimulation) {
  set.seed(123)

  # Select the appropriate dataframe based on gender
  if (gender == "f") {
    gymnast_data <- sampling_usa_data_2022_2023_f
  } else if (gender == "m") {
    gymnast_data <- sampling_usa_data_2022_2023_m
  } else {
    stop("Invalid gender. Use 'f' for female or 'm' for male.")
  }

  # Identify unique gymnasts
  unique_gymnasts <- unique(gymnast_data[, c("FirstName", "LastName")])

  # Create a new dataframe to store sampled scores
  n_iterations_data <- data.frame(
    FirstName = character(),
    LastName = character()
  )

  for (n in 1:nsimulation) {
    sampled_scores_data <- data.frame(
      FirstName = character(),
      LastName = character(),
      stringsAsFactors = FALSE
    )

    for (i in 1:nrow(unique_gymnasts)) {
      # Extract the current gymnast's information
      current_gymnast <- unique_gymnasts[i, ]

      # Subset the data for the current gymnast
      subset_data <- gymnast_data[
        gymnast_data$FirstName == current_gymnast$FirstName &
        gymnast_data$LastName == current_gymnast$LastName &
        gymnast_data$Apparatus == event_name,
      ]

      # Check if the gymnast has at least 5 rows of data
      if (nrow(subset_data) < 5) {
        next  # Skip to the next gymnast
      }

      if (nrow(subset_data) == 0) {
        # If the subset is empty, set the sampled value to 0
        sampled_score <- 0
      } else {
        # Calculate mean and standard deviation
        mean_score <- mean(subset_data$Score)
        sd_score <- sd(subset_data$Score)
        max_cutoff <- max(subset_data$Score) + 0.3

        # Initialize sampled_score
        sampled_score <- NA

        # Sample from the t-distribution until the score is less than or equal to max_cutoff
        while (is.na(sampled_score) || sampled_score > max_cutoff) {
          df <- max(nrow(subset_data) - 1, 1)  # to avoid df being zero
          sampled_score <- mean_score + rt(1, df) * sd_score
        }
      }

      # Create a data frame for the current gymnast's sampled scores
      current_data <- data.frame(
        FirstName = current_gymnast$FirstName,
        LastName = current_gymnast$LastName,
        Score = sampled_score,
        stringsAsFactors = FALSE
      )

      # Append the current data to the overall sampled_scores_data dataframe
      sampled_scores_data <- rbind(sampled_scores_data, current_data)
    }

    # Combine the scores into n_iterations_data
    if (n == 1) {
    n_iterations_data <- sampled_scores_data
    } else {
    n_iterations_data <- cbind(n_iterations_data, sampled_scores_data$Score)
    colnames(n_iterations_data)[ncol(n_iterations_data)] <- paste("Score_", n, sep = "")
  }

  }
    # add an average scores across sims for each athlete
    columns_to_average <- n_iterations_data[, -(1:2)]

    # Calculate the row-wise mean for the selected columns
    n_iterations_data$AverageScore <- rowMeans(columns_to_average, na.rm = TRUE)
    #final_average_df <- n_iterations_data[, c(1, 2, ncol(n_iterations_data))]
    #final_average_df = final_average_df[order(-final_average_df$AverageScore), ]

  return(n_iterations_data)
}

```

```{r}
# Example usage for female data:
event_name <- "FX"
gender <- "f"
nsimulation <- 10
result_female <- simulate_gymnastics_event(event_name, gender, nsimulation)

# Example usage for male data:
event_name <- "PB"
gender <- "m"
nsimulation <- 10
result_male <- simulate_gymnastics_event(event_name, gender, nsimulation)

```

```{r womens sims}
# List of women's events
women_events <- c("BB", "UB", "FX", "VT")

# Number of simulations
nsimulation <- 1000

# Loop over women's events
for (event_name in women_events) {
  # Generate dataframe name
  dataframe_name <- paste0(event_name, "_usa_womens_sims")

  # Run the function for the specific event and save the results
  assign(dataframe_name, simulate_gymnastics_event(event_name, "f", nsimulation))
}

# Access the dataframes for each event
BB_usa_womens_sims  # Replace with the specific dataframe name you want to access
UB_usa_womens_sims
FX_usa_womens_sims
VT_usa_womens_sims
```



```{r mens sims}
# List of men's events
men_events <- c("PB", "HB", "PH", "FX", "SR", "VT")

# Number of simulations
nsimulation <- 1000

# Loop over men's events
for (event_name in men_events) {
  # Generate dataframe name
  dataframe_name <- paste0(event_name, "_usa_mens_sims")

  # Run the function for the specific event and save the results
  assign(dataframe_name, simulate_gymnastics_event(event_name, "m", nsimulation))
}

# Access the dataframes for each event
PB_usa_mens_sims  # Replace with the specific dataframe name you want to access
HB_usa_mens_sims
PH_usa_mens_sims
FX_usa_mens_sims
SR_usa_mens_sims
VT_usa_mens_sims
```


```{r all-round}
topAAmen <- data_2022_2023_m %>% 
  filter(Gender == "m", Round == "AAfinal") %>% 
  group_by(LastName, FirstName, Competition, Country) %>% 
  summarize(AAtotal = sum(Score))

topAAwomen <- data_2022_2023_f %>% 
  filter(Gender == "w", Round == "AAfinal") %>% 
  group_by(LastName, FirstName, Competition, Country) %>% 
  summarize(AAtotal = sum(Score))

top24AAmen <- topAAmen %>% 
  group_by(LastName,FirstName,Country) %>% 
  summarize(AAmean = mean(AAtotal)) %>% 
  arrange(desc(AAmean)) %>% 
  head(24)

top24AAwomen <- topAAwomen %>% 
  group_by(LastName,FirstName,Country) %>% 
  summarize(AAmean = mean(AAtotal)) %>% 
  arrange(desc(AAmean)) %>% 
  head(24)
```

```{r womens}
library(patchwork)
BBplot <- ggplot(topusawomen %>% filter(Apparatus == "BB"), aes(y = reorder(Name,mean), x = Score, color = Name)) + 
  geom_point(alpha = 0.5)
UBplot <- ggplot(topusawomen %>% filter(Apparatus == "UB"), aes(y = reorder(Name,mean), x = Score, color = Name)) + 
  geom_point(alpha = 0.5)
FXplot <- ggplot(topusawomen %>% filter(Apparatus == "FX"), aes(y = reorder(Name,mean), x = Score, color = Name)) + 
  geom_point(alpha = 0.5)
VTplot <- ggplot(topusawomen %>% filter(Apparatus == "VT"), aes(y = reorder(Name,mean), x = Score, color = Name)) + 
  geom_point(alpha = 0.5)

BBplot
```

```{r}
ggplot(mpg, aes(displ, hwy)) +
  geom_point(data = transform(mpg, class = NULL), colour = "grey85") +
  geom_point() +
  facet_wrap(vars(class))
```


making new data frame for past womens' team all-around scores

```{r womensteam}
#country = c("USA", "BRA", "FRA", "CHN", "ITA", "GBR", "NED", "JPN")
#year = c(2023,2023,2023,2023,2023,2023,2023,2023)
#meet = c("2023 52nd FIG Artistic Gymnastics World Championships")
womens_team_results = data.frame(mean_score = c(167.729,165.530,164.064,163.162,162.997,161.864,159.563,157.496,
          166.564, 163.363, 160.563, 159.661, 159.463, 157.529, 156.964, 155.863,
          172.330, 166.529,164.796,164.230,163.638, 161.495,160.563,159.427,
          171.629, 162.863, 162.396, 161.644, 161.294, 160.262, 159.830, 159.428))
```



```{r mensteam}
#country = c("JPN", "CHN", "USA", "GBR", "SUI", "GER", "CAN", "ITA")
#year = c(2023,2023,2023,2023,2023,2023,2023,2023)
#meet = c("2023 52nd FIG Artistic Gymnastics World Championships")
mens_team_results = data.frame(mean_score = c(255.584,253.794,252.428,249.461,244.426,244.026,243.028,241.16,
          257.858, 253.395,247.229, 245.995, 245.692, 244.027, 241.361,232.868,
          261.726, 260.729, 258.159, 254.578, 251.611, 248.243, 247.038, 246.593,
          256.634, 256.858, 253.744, 251.994, 248.628, 244.294,243.994,240.660))
```
 
```{r gencutoffs}
mt_cutoffs <- getmedalcutoffs(mens_team_results)
wt_cutoffs <- getmedalcutoffs(womens_team_results)
```
 






