```{r}
#| label: load-libraries

library(readr)
library(tidyverse)
library(dplyr)
library(stringr)
library(lubridate)
```

```{r}
#| label: load-data
data_2022_2023 <- read_csv("Data/data_2022_2023.csv")
data_2017_2021 <- read_csv("Data/data_2017_2021.csv")

#DO NOT CHANGE ORDER

data_2022_2023$Apparatus[data_2022_2023$Apparatus == "VT2"] <- "VT"
data_2022_2023$Apparatus[data_2022_2023$Apparatus == "VT1"] <- "VT"

data_2022_2023$Penalty[is.na(data_2022_2023$Penalty)] <- 0

#Girls filtering for middle name
data_2022_2023$FirstName[data_2022_2023$FirstName == "Joscelyn Michelle"] <- "Joscelyn"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Nola Rhianne"] <- "Nola"

#Guys filtering for middle name
data_2022_2023$FirstName[data_2022_2023$FirstName == "Taylor Troy"] <- "Taylor"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Joshua Andrew"] <- "Joshua"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Yul Kyung Tae"] <- "Yul"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Curran Michael"] <- "Curran"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Frederick Nathaniel"] <- "Frederick"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Ian Hunter"] <- "Ian"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Shane Michael"] <- "Shane"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Khoi Alexander"] <- "Khoi"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Yunus Emre"] <- "Yunus"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Yuan-Hsi"] <- "Yuan Hsi"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Yu-Jan"] <- "Yu Jan"

data_2022_2023$LastName[data_2022_2023$LastName == "VILLAVERDE MEDEROS"] <- "VILLAVERDE"

data_2022_2023$LastName[data_2022_2023$LastName == "VALENZUELA ASTUDILLO"] <- "VALENZUELA"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Yiseth Eliana"] <- "Yiseth"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Yi-Chen"] <- "Yi Chen"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Yi-Chun"] <- "Yi Chun"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Yefferson Gregorio"] <- "Yefferson"
data_2022_2023$LastName[data_2022_2023$LastName == "ANTON YEGUEZ"] <- "ANTON"

data_2022_2023$LastName[data_2022_2023$LastName == "ANTON YEGUEZ"] <- "ANTON"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Wout Johan Alexander"] <- "Wout"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Wilfry Manuel"] <- "Wilfry"

data_2022_2023$FirstName[data_2022_2023$FirstName == "Wei-Sheng"] <- "Wei Sheng"

data_2022_2023$FirstName[(data_2022_2023$Competition == "BIRMINGHAM 2022 Commonwealth Games") & (is.na(data_2022_2023$LastName))] <- "Kate"

data_2022_2023$LastName[(data_2022_2023$Competition == "BIRMINGHAM 2022 Commonwealth Games") & (is.na(data_2022_2023$LastName))] <- "MCDONALD"

data_2022_2023$FirstName[data_2022_2023$LastName == "SOUZA BITENCOU"] <- "Lucas"
data_2022_2023$LastName[data_2022_2023$LastName == "SOUZA BITENCOU"] <- "BITENCOURT"

data_2022_2023$LastName[data_2022_2023$LastName == "DE JESUS DOS SANTOS"] <- "JESUS SANTOS"

data_2022_2023$FirstName[data_2022_2023$LastName == "JESUS SANT"] <- "Melanie"
data_2022_2023$LastName[data_2022_2023$LastName == "JESUS SANT"] <- "JESUS SANTOS"

data_2022_2023$LastName[data_2022_2023$LastName == "ELPITIYA BADALGE DONA"] <- "GEHANI"
data_2022_2023$FirstName[data_2022_2023$FirstName == "Milka Gehani"] <- "Milka"

data_2022_2023$FirstName[data_2022_2023$LastName == "ELPITIYA BADALG D"] <- "Milka"

data_2022_2023$LastName[data_2022_2023$LastName == "ELPITIYA BADALG D"] <- "GEHANI"

data_2022_2023$FirstName[(data_2022_2023$Competition == "2022 51st FIG Artistic Gymnastics World Championship") & (is.na(data_2022_2023$LastName))] <- "Kate"

data_2022_2023$LastName[(data_2022_2023$Competition == "2022 51st FIG Artistic Gymnastics World Championship") & (is.na(data_2022_2023$LastName))] <- "MCDONALD"

data_2022_2023$FirstName[(data_2022_2023$Competition == "2023 Varna World Challenge Cup") & (is.na(data_2022_2023$LastName))] <- "Daria"

data_2022_2023$LastName[(data_2022_2023$Competition == "2023 Varna World Challenge Cup") & (is.na(data_2022_2023$LastName))] <- "HARTMANN"

data_2022_2023$FirstName[data_2022_2023$LastName == "ABIYURAFI"] <- "Abiyu"
data_2022_2023$LastName[data_2022_2023$LastName == "ABIYURAFI"] <- "Rafi"


#Konnor McClain should not be considered, she has hand surgery

```

```{r}
#| label: usa-filter-data

usa_data_2022_2023 <- data_2022_2023 |>
  filter(`Country` == "USA")

usa_data_2017_2021 <- data_2017_2021 |>
  filter(`Country` == "USA")

data_2022_2023 <- rbind(data_2022_2023, data_2017_2021)

data_2022_2023$Apparatus[data_2022_2023$Apparatus == "VT2"] <- "VT"
data_2022_2023$Apparatus[data_2022_2023$Apparatus == "VT1"] <- "VT"

usa_data_2022_2023 <- rbind(usa_data_2022_2023, usa_data_2017_2021)

data_2017_2021 |>
  summarise(mean = mean(Score, na.rm = TRUE))

data_2022_2023 |>
  summarise(mean = mean(Score))

usa_data_2022_2023_f <-  usa_data_2022_2023 |>
  filter(Gender == "w")

usa_data_2022_2023_m <- usa_data_2022_2023 |>
  filter(Gender == "m")

data_2022_2023_f <- data_2022_2023 |>
  filter(Gender == "w")

data_2022_2023_m <- data_2022_2023 |>
  filter(Gender == "m")

ggplot(aes(x= Score), data = usa_data_2022_2023_f) + geom_histogram() + facet_wrap(~Apparatus, scales = "free_y", ncol = 2)

ggplot(aes(x= Score), data = usa_data_2022_2023_m) + geom_histogram() + facet_wrap(~Apparatus, scales = "free_y", ncol = 2)


mean_usa_app <- usa_data_2022_2023_f |>
  group_by(LastName, FirstName, Apparatus) |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score))

mean_usa_app_men <- usa_data_2022_2023_m |>
  group_by(LastName, FirstName, Apparatus) |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score))

usa_data_2022_2023_f_BB <- mean_usa_app |>
  filter(Apparatus == "BB") |>
  arrange(desc(mean_score))

usa_data_2022_2023_f_UB <- mean_usa_app |>
  filter(Apparatus == "UB") |>
  arrange(desc(mean_score))

usa_data_2022_2023_f_FX <- mean_usa_app |>
  filter(Apparatus == "FX") |>
  arrange(desc(mean_score))

usa_data_2022_2023_f_VT <- mean_usa_app |>
  filter(Apparatus == "VT") |>
  arrange(desc(mean_score))

mean_usa_app

mean_usa_app_men

usa_data_2022_2023_f_BB
usa_data_2022_2023_f_UB
usa_data_2022_2023_f_FX
usa_data_2022_2023_f_VT

mean_usa_app |>
  group_by(LastName, FirstName) |>
  filter(Apparatus != "VT1",
         Apparatus != "VT2") |>
  summarise(sum = sum(mean_score)) |>
  arrange(desc(sum))

VT_ranks <- data_2022_2023_f |>
  group_by(LastName, FirstName, Country, Apparatus) |>
  filter(Apparatus == "VT") |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score)) |>
  arrange(desc(mean_score)) |>
  head(24)

BB_ranks <- data_2022_2023_f |>
  group_by(LastName, FirstName, Country, Apparatus) |>
  filter(Apparatus == "BB") |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score)) |>
  arrange(desc(mean_score)) |>
  head(24)

UB_ranks <- data_2022_2023_f |>
  group_by(LastName, FirstName, Country, Apparatus) |>
  filter(Apparatus == "UB") |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score)) |>
  arrange(desc(mean_score)) |>
  head(24)

FX_ranks <- data_2022_2023_f |>
  group_by(LastName, FirstName, Country, Apparatus) |>
  filter(Apparatus == "FX") |>
  summarise(mean_score = mean(Score),
            sd_score = sd(Score)) |>
  arrange(desc(mean_score)) |>
  head(24)

VT_ranks
BB_ranks
UB_ranks
FX_ranks

```

```{r}
#breakdown of teams qualifying rank

tb_2016_f <- data.frame(rank = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
                      country = c("USA", "CHN", "RUS", "GBR", "BRA", "GER", "JPN", "NED", "CAN", "ITA", "FRA", "BEL"),
                      all_around = c(3, 2, 3, 2, 3, 2, 3, 3, 2, 2, 3, 2))

tb_2016_f <- tb_2016_f |>
  mutate(year = "2016",
         made_final = ifelse(rank <= 8, "yes", "no"),
         gender = "F")

tb_2016_m <- data.frame(rank = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
                      country = c("CHN", "USA", "RUS", "JPN", "GBR", "BRA", "UKR", "GER", "SUI", "NED", "KOR", "FRA"),
                      all_around = c(2, 2, 3, 2, 3, 3, 2, 2, 3, 3, 1, 2))

tb_2016_m <- tb_2016_m |>
  mutate(year = "2016",
         made_final = ifelse(rank <= 8, "yes", "no"),
         gender = "M")

tb_2012_f <- data.frame(rank = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
                      country = c("USA", "RUS", "CHN", "ROU", "GBR", "JPN", "ITA", "CAN", "GER", "AUS", "FRA", "BRA"),
                      all_around = c(3, 3, 3, 2, 3, 2, 3, 2, 2, 2, 2, 3))

tb_2012_f <- tb_2012_f |>
  mutate(year = "2012",
         made_final = ifelse(rank <= 8, "yes", "no"),
         gender = "F")

tb_2012_m <- data.frame(rank = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
                      country = c("USA", "RUS", "GBR", "GER", "JPN", "CHN", "UKR", "FRA", "ESP", "ROU", "ITA", "KOR"),
                      all_around = c(2, 2, 2, 3, 3, 1, 3, 1, 3, 1, 3, 1))

tb_2012_m <- tb_2012_m |>
  mutate(year = "2012",
         made_final = ifelse(rank <= 8, "yes", "no"),
         gender = "M")

tb_f <- rbind(tb_2016_f, tb_2012_f) |>
  mutate(all_around = as.character(all_around))

ggplot(data = tb_f, aes(x = all_around, fill = made_final)) +
  geom_bar()

ggplot(data = tb_f, aes(y = all_around, x = rank)) +
  geom_line()
```

```{r date_things}

# Assuming your dataframe is called data_2022_2023 and the column with dates is "Date"

# Step 1: Create a function to extract the second date from each string
extract_second_date <- function(date_string) {
  parts <- str_extract_all(date_string, "\\d{1,2}\\s[A-Za-z]+\\s\\d{4}")[[1]]
  if (length(parts) == 2) {
    # If there are two dates, return the second one
    return(parts[2])
  } else if (length(parts) == 1) {
    # If there is only one date, return it
    return(parts[1])
  } else {
    return(NA)
  }
}

# Step 2: Apply the function to the Date column and convert to Date objects
data_2022_2023 <- data_2022_2023 %>%
  mutate(
    SecondDateStr = sapply(Date, extract_second_date),
    SecondDate = dmy(SecondDateStr)
  )

# Define the end date
end_date <- dmy("27-07-2024")

# Calculate the number of days from the SecondDate to the end date
data_2022_2023 <- data_2022_2023 %>%
  mutate(
    DaysUntilOlympics = as.integer(end_date - SecondDate)
  )

# Inspect the changes
head(data_2022_2023)

```

```{r standardize_scores}
data_2022_2023 <- data_2022_2023 %>%
  group_by(Apparatus, Gender) %>%
  mutate(
    StandardizedScore = (Score - mean(Score, na.rm = TRUE)) / sd(Score, na.rm = TRUE)
  ) %>%
  ungroup()
```
